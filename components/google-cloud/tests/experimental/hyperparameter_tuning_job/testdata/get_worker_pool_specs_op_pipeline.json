{
  "components": {
    "comp-get-worker-pool-specs": {
      "executorLabel": "exec-get-worker-pool-specs",
      "inputDefinitions": {
        "parameters": {
          "best_hyperparameters": { "parameterType": "LIST" },
          "worker_pool_specs": { "parameterType": "LIST" }
        }
      },
      "outputDefinitions": {
        "parameters": { "output": { "parameterType": "LIST" } }
      }
    }
  },
  "deploymentSpec": {
    "executors": {
      "exec-get-worker-pool-specs": {
        "container": {
          "args": [
            "--best-hyperparameters",
            "{{$.inputs.parameters['best_hyperparameters']}}",
            "--worker-pool-specs",
            "{{$.inputs.parameters['worker_pool_specs']}}",
            "----output-paths",
            "{{$.outputs.parameters['output'].output_file}}"
          ],
          "command": [
            "sh",
            "-c",
            "(PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --no-warn-script-location 'google-cloud-aiplatform==1.18.3' || PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --no-warn-script-location 'google-cloud-aiplatform==1.18.3' --user) && \"$0\" \"$@\"",
            "sh",
            "-ec",
            "program_path=$(mktemp)\nprintf \"%s\" \"$0\" > \"$program_path\"\npython3 -u \"$program_path\" \"$@\"\n",
            "def get_worker_pool_specs(best_hyperparameters,\n                         worker_pool_specs):\n  \"\"\"Constructs worker_pool_specs based on the best hyperparameters.\n\n  Args:\n      best_hyperparameters (list): Required. List representing the intermediate\n        JSON representation of the best hyperparameters from the\n        hyperparameter tuning job.\n      worker_pool_specs (list): Required. The spec of the worker pools\n        including machine type and Docker image. All worker pools except the\n        first one are optional and can be skipped by providing an empty value.\n\n  Returns:\n      List containing an intermediate JSON representation of the\n      worker_pool_specs updated with the best hyperparameters as arguments\n      in the container_spec.\n\n  \"\"\"\n  from google.cloud.aiplatform_v1.types import study\n\n  for worker_pool_spec in worker_pool_specs:\n    if 'args' not in worker_pool_spec['container_spec']:\n      worker_pool_spec['container_spec']['args'] = []\n    for param in best_hyperparameters:\n      p = study.Trial.Parameter.from_json(param)\n      worker_pool_spec['container_spec']['args'].append(\n          f'--{p.parameter_id}={p.value}')\n\n  return worker_pool_specs\n\ndef _serialize_json(obj) -> str:\n    if isinstance(obj, str):\n        return obj\n    import json\n\n    def default_serializer(obj):\n        if hasattr(obj, 'to_struct'):\n            return obj.to_struct()\n        else:\n            raise TypeError(\n                \"Object of type '%s' is not JSON serializable and does not have .to_struct() method.\"\n                % obj.__class__.__name__)\n\n    return json.dumps(obj, default=default_serializer, sort_keys=True)\n\nimport json\nimport argparse\n_parser = argparse.ArgumentParser(prog='Get worker pool specs', description='Constructs worker_pool_specs based on the best hyperparameters.')\n_parser.add_argument(\"--best-hyperparameters\", dest=\"best_hyperparameters\", type=json.loads, required=True, default=argparse.SUPPRESS)\n_parser.add_argument(\"--worker-pool-specs\", dest=\"worker_pool_specs\", type=json.loads, required=True, default=argparse.SUPPRESS)\n_parser.add_argument(\"----output-paths\", dest=\"_output_paths\", type=str, nargs=1)\n_parsed_args = vars(_parser.parse_args())\n_output_files = _parsed_args.pop(\"_output_paths\", [])\n\n_outputs = get_worker_pool_specs(**_parsed_args)\n\n_outputs = [_outputs]\n\n_output_serializers = [\n    _serialize_json,\n\n]\n\nimport os\nfor idx, output_file in enumerate(_output_files):\n    try:\n        os.makedirs(os.path.dirname(output_file))\n    except OSError:\n        pass\n    with open(output_file, 'w') as f:\n        f.write(_output_serializers[idx](_outputs[idx]))\n"
          ],
          "image": "python:3.10"
        }
      }
    }
  },
  "pipelineInfo": { "name": "get-worker-pool-specs-op-test" },
  "root": {
    "dag": {
      "tasks": {
        "get-worker-pool-specs": {
          "cachingOptions": { "enableCache": true },
          "componentRef": { "name": "comp-get-worker-pool-specs" },
          "inputs": {
            "parameters": {
              "best_hyperparameters": {
                "runtimeValue": {
                  "constant": [
                    "{\n \"parameterId\": \"learning_rate\",\n \"value\": 0.028\n}",
                    "{\n \"parameterId\": \"momentum\",\n \"value\": 0.49\n}",
                    "{\n \"parameterId\": \"num_neurons\",\n \"value\": 512.0\n}"
                  ]
                }
              },
              "worker_pool_specs": {
                "runtimeValue": {
                  "constant": [
                    {
                      "container_spec": {
                        "image_uri": "gcr.io/project_id/test"
                      },
                      "machine_spec": {
                        "accelerator_count": 1.0,
                        "accelerator_type": "NVIDIA_TESLA_T4",
                        "machine_type": "n1-standard-4"
                      },
                      "replica_count": 1.0
                    }
                  ]
                }
              }
            }
          },
          "taskInfo": { "name": "get-worker-pool-specs" }
        }
      }
    }
  }
}
